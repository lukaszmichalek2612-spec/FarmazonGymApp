<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FarmazonGymApp — Trainer</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo"><div class="brand">FarmazonGymApp</div><div class="small">Panel Trenera</div></div>
    <div class="controls">
      <div id="trainerEmail" class="small"></div>
      <button id="btnTrainerSelf" class="button" style="display:none">Moje treningi</button>
      <button id="btnSignOut" class="ghost">Wyloguj</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;gap:12px">
      <div style="width:320px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Użytkownicy</strong>
          <input id="searchUser" placeholder="szukaj email" style="width:160px" />
        </div>
        <div id="usersList" class="list" style="margin-top:8px"></div>
      </div>
      <div style="flex:1">
        <div id="clientArea" class="list small muted">Wybierz klienta, aby zobaczyć i przypisać plan.</div>
      </div>
    </div>
  </div>

  <div class="footer">Panel Trenera — możesz przeglądać i przypisywać plany</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script src="app.js"></script>
<script>
(function(){
  function waitForLib(timeout=5000){ return new Promise((resolve,reject)=>{ const start=Date.now(); (function check(){ if(window.appLib && window.appLib.auth && window.appLib.db) return resolve(window.appLib); if(Date.now()-start>timeout) return reject('appLib not ready'); setTimeout(check,50); })(); }); }

  waitForLib().then(appLib=>{
    const auth = appLib.auth, db = appLib.db, uid = appLib.uid;
    const trainerEmail = document.getElementById('trainerEmail');
    const btnSignOut = document.getElementById('btnSignOut');
    const usersList = document.getElementById('usersList');
    const clientArea = document.getElementById('clientArea');
    const searchUser = document.getElementById('searchUser');
    const btnTrainerSelf = document.getElementById('btnTrainerSelf');

    let currentUid = null;
    auth.onAuthStateChanged(async user=>{
      if(!user) { window.location.href='login.html'; return; }
      currentUid = user.uid; trainerEmail.textContent = user.email;
      const doc = await db.collection('users').doc(currentUid).get();
      const role = doc.exists ? doc.data().role : 'user';
      if(role !== 'trainer'){ alert('Brak uprawnień trenera'); window.location.href='app.html'; return; }
      btnTrainerSelf.style.display = 'inline-block';
      loadUsers();
    });

    btnSignOut.addEventListener('click', ()=> auth.signOut());

    async function loadUsers(q=''){
      usersList.innerHTML = '';
      const snap = await db.collection('users').limit(200).get();
      const arr = [];
      snap.forEach(d=>{ const data=d.data(); data.id=d.id; if(q){ if(String(data.email||'').includes(q)) arr.push(data); } else arr.push(data); });
      arr.forEach(u=>{
        if(u.role === 'trainer') return;
        const div = document.createElement('div'); div.className='row'; div.style.justifyContent='space-between';
        div.innerHTML = `<div style="flex:1"><strong>${esc(u.email||u.id)}</strong><div class="small">${u.createdAt?new Date(u.createdAt.seconds*1000).toLocaleDateString():''}</div></div>
          <div style="display:flex;gap:6px"><button class="ghost viewBtn" data-id="${u.id}">Otwórz</button></div>`;
        div.querySelector('.viewBtn').addEventListener('click', ()=> openClient(u.id));
        usersList.appendChild(div);
      });
    }

    searchUser.addEventListener('input', ()=> loadUsers(searchUser.value.trim()));

    async function openClient(uid){
      clientArea.innerHTML = '<div class="small muted">Ładowanie...</div>';
      const snap = await db.collection('users').doc(uid).collection('plans').orderBy('createdAt','desc').get();
      const plans = []; snap.forEach(d=>{ const data=d.data(); data.id=d.id; plans.push(data); });
      let html = `<h3>Plany użytkownika</h3><div style="display:flex;gap:8px;flex-wrap:wrap">`;
      plans.forEach(p=>{
        html += `<div style="min-width:220px" class="card"><strong>${esc(p.title)}</strong><div class="small">${(p.weeks||[]).length} tyg.</div>
          <div style="margin-top:8px;display:flex;gap:6px"><button class="ghost viewPlan" data-plan="${p.id}" data-uid="${uid}">Podgląd</button><button class="button assignPlan" data-plan="${p.id}" data-uid="${uid}">Przypisz</button></div></div>`;
      });
      html += `</div>`; clientArea.innerHTML = html;
      clientArea.querySelectorAll('.viewPlan').forEach(b=> b.addEventListener('click', async (e)=>{ const ownerUid = e.currentTarget.dataset.uid; try{ await window.FG.trainerOpenClient(ownerUid); appLib.showToast('Otworzono plany klienta'); window.location.href='app.html'; }catch(err){ alert(err.message||err); } }));
      clientArea.querySelectorAll('.assignPlan').forEach(b=> b.addEventListener('click', async (e)=>{ const planId = e.currentTarget.dataset.plan; const ownerUid = e.currentTarget.dataset.uid; const planDoc = await db.collection('users').doc(ownerUid).collection('plans').doc(planId).get(); if(!planDoc.exists) return alert('Plan nie znaleziony'); const planData = planDoc.data(); planData.id = uid('plan'); planData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection('users').doc(ownerUid).collection('plans').doc(planData.id).set(planData); alert('Plan skopiowany i przypisany (demo).'); }));
    }

    btnTrainerSelf.addEventListener('click', async ()=>{ try{ await window.FG.setMode('trainer-self'); window.location.href='app.html'; }catch(e){ alert(e.message||e); } });

  }).catch(err=>{
    console.error('trainer init error', err);
    document.addEventListener('DOMContentLoaded', ()=>{ document.body.insertAdjacentHTML('afterbegin','<div style="color:#900;padding:8px">Błąd inicjalizacji panelu trenera: '+(err||'')+'</div>'); });
  });
})();
</script>
</body>
</html>
