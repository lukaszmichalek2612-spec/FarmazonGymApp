<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FarmazonGymApp ‚Äî App</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">
      <div>
        <div class="brand">FarmazonGymApp</div>
        <div class="small">Aplikacja u≈ºytkownika</div>
      </div>
    </div>
    <div class="controls">
      <div id="userEmail" class="small"></div>
      <button id="btnSignOut" class="ghost">Wyloguj</button>
    </div>
  </div>

  <div class="kpis card" style="margin-top:12px">
    <div class="kpi">
      <div class="small muted">Objƒôto≈õƒá tygodnia</div>
      <div id="kpiWeekVol" style="font-size:22px;font-weight:900">‚Äî</div>
    </div>
    <div class="kpi">
      <div class="small muted">ƒÜwicze≈Ñ w tygodniu</div>
      <div id="kpiExCount" style="font-size:22px;font-weight:900">‚Äî</div>
    </div>
    <div class="kpi">
      <div class="small muted">Wykonane serie</div>
      <div id="kpiDoneSets" style="font-size:22px;font-weight:900">‚Äî</div>
    </div>
    <div class="kpi" style="flex:1;min-width:280px">
      <div class="small muted">1RM (Epley) ‚Äî szybki kalkulator</div>
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <input id="rmW" placeholder="kg" style="max-width:140px" />
        <input id="rmR" placeholder="powt." style="max-width:140px" />
        <div class="badge" id="rmOut">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="side card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Plany</strong>
        <button id="btnAddPlan" class="button" title="Dodaj plan">‚ûï</button>
      </div>
      <div id="plansList" class="list" style="margin-top:10px"></div>
      <hr class="sep" />
      <div class="small muted">Tip: Zmiany zapisujƒÖ siƒô automatycznie.</div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>
          <div id="planTitle" style="font-weight:900;font-size:20px">Wybierz plan</div>
          <div id="planDesc" class="small muted">‚Äî</div>
        </div>
        <div class="row" style="flex-wrap:wrap">
          <select id="trainingSelect" style="min-width:220px"></select>
          <button id="btnAddTraining" class="button">‚ûï Trening</button>
        </div>
      </div>

      <div class="row" style="gap:10px;margin-top:12px;align-items:center;flex-wrap:wrap">
        <label class="small muted">Tydzie≈Ñ:</label>
        <select id="weekSelect" style="width:220px"></select>
        <button id="btnAddWeek" class="button">‚ûï Dodaj tydzie≈Ñ</button>
        <button id="btnDupWeek" class="ghost">Duplikuj tydzie≈Ñ</button>
        <button id="btnDelWeek" class="ghost danger">Usu≈Ñ tydzie≈Ñ</button>
        <div class="badge" id="saveState">Autosave: ON</div>
      </div>

      <div id="trainingArea" style="margin-top:12px" class="list">
        <div class="small muted">Wybierz plan i tydzie≈Ñ aby zobaczyƒá treningi.</div>
      </div>
    </div>
  </div>

  <div class="footer">FarmazonGymApp ‚Äî dane w Firestore (users/{uid}/plans)</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="app.js"></script>
<script>
const lib = window.appLib;
const userEmail = document.getElementById('userEmail');
const btnSignOut = document.getElementById('btnSignOut');
const plansList = document.getElementById('plansList');
const btnAddPlan = document.getElementById('btnAddPlan');
const planTitle = document.getElementById('planTitle');
const planDesc = document.getElementById('planDesc');
const trainingSelect = document.getElementById('trainingSelect');
const btnAddTraining = document.getElementById('btnAddTraining');
const weekSelect = document.getElementById('weekSelect');
const btnAddWeek = document.getElementById('btnAddWeek');
const btnDupWeek = document.getElementById('btnDupWeek');
const btnDelWeek = document.getElementById('btnDelWeek');
const trainingArea = document.getElementById('trainingArea');
const saveState = document.getElementById('saveState');
const kpiWeekVol = document.getElementById('kpiWeekVol');
const kpiExCount = document.getElementById('kpiExCount');
const kpiDoneSets = document.getElementById('kpiDoneSets');
const rmW = document.getElementById('rmW');
const rmR = document.getElementById('rmR');
const rmOut = document.getElementById('rmOut');

let currentUser = null;
let state = { plans:[], activePlanId:null, activeWeekId:null };

function setSaving(s){
  saveState.textContent = s ? 'Zapisujƒô‚Ä¶' : 'Autosave: ON';
  saveState.style.opacity = s ? 0.8 : 1;
}

btnSignOut.addEventListener('click', ()=> lib.logout());

function recalcKpis(plan, week){
  if(!plan || !week || !week.data || !week.data.trainings){
    kpiWeekVol.textContent = '‚Äî'; kpiExCount.textContent='‚Äî'; kpiDoneSets.textContent='‚Äî'; return;
  }
  const { volume, exCount, doneSets, allSets } = lib.calcWeekStats(week);
  kpiWeekVol.textContent = Math.round(volume).toLocaleString('pl-PL') + ' kg';
  kpiExCount.textContent = exCount.toLocaleString('pl-PL');
  kpiDoneSets.textContent = doneSets + ' / ' + allSets;
}

function renderPlans(){
  plansList.innerHTML = '';
  if(!state.plans.length) { plansList.innerHTML = '<div class="small muted">Brak plan√≥w</div>'; return; }
  state.plans.forEach(p=>{
    const div = document.createElement('div'); div.className='row';
    const weeksCount = (p.weeks||[]).length;
    div.innerHTML = `<div style="flex:1">
        <strong>${lib.esc(p.title)}</strong>
        <div class="small muted">${weeksCount} tyg.</div>
      </div>
      <div class="row" style="gap:8px">
        <button class="ghost openBtn" data-id="${p.id}">Otw√≥rz</button>
        <button class="ghost danger delBtn" data-id="${p.id}">üóëÔ∏è</button>
      </div>`;
    div.querySelector('.openBtn').addEventListener('click', ()=>{
      state.activePlanId = p.id;
      const firstWeek = (p.weeks||[])[0];
      state.activeWeekId = firstWeek ? firstWeek.id : null;
      renderAll();
    });
    div.querySelector('.delBtn').addEventListener('click', async ()=>{
      if(confirm('UsunƒÖƒá plan?')) await lib.deletePlan(currentUser.uid, p.id);
    });
    plansList.appendChild(div);
  });
}

function renderHeader(){
  const plan = state.plans.find(x=>x.id===state.activePlanId);
  trainingSelect.innerHTML=''; weekSelect.innerHTML='';
  if(!plan){ planTitle.textContent='Wybierz plan'; planDesc.textContent='‚Äî'; return; }
  planTitle.textContent = plan.title;
  planDesc.textContent = plan.desc||'';

  (plan.trainings||[]).forEach(t=>{
    const o = document.createElement('option');
    o.value=t.id; o.textContent=t.title;
    trainingSelect.appendChild(o);
  });

  (plan.weeks||[]).forEach(w=>{
    const o = document.createElement('option');
    o.value=w.id; o.textContent=w.title;
    weekSelect.appendChild(o);
  });

  if(!state.activeWeekId && plan.weeks && plan.weeks.length) state.activeWeekId = plan.weeks[0].id;
  weekSelect.value = state.activeWeekId || '';
}

function renderTrainingArea(){
  trainingArea.innerHTML = '';
  const plan = state.plans.find(p=>p.id===state.activePlanId);
  if(!plan) return;
  const week = (plan.weeks||[]).find(w=>w.id===state.activeWeekId);
  if(!week){ trainingArea.innerHTML = '<div class="small muted">Dodaj tydzie≈Ñ, aby edytowaƒá treningi.</div>'; recalcKpis(null,null); return; }

  lib.ensureWeekData(plan, week);
  recalcKpis(plan, week);

  (week.data.trainings||[]).forEach(tr=>{
    const det = document.createElement('details'); det.className='details'; det.open = true;
    const sum = document.createElement('summary');
    const trVol = lib.calcTrainingVolume(tr);
    sum.innerHTML = `<div><strong>${lib.esc(tr.title)}</strong> <span class="badge">${Math.round(trVol).toLocaleString('pl-PL')} kg</span></div>
                     <div class="small muted">kliknij aby zwinƒÖƒá</div>`;
    det.appendChild(sum);

    const body = document.createElement('div'); body.style.marginTop = '8px';

    (tr.exercises||[]).forEach(ex=>{
      const exWrap = document.createElement('div');
      exWrap.className = 'details';
      exWrap.style.marginBottom = '10px';
      const exHeader = document.createElement('div');
      exHeader.className = 'row';
      exHeader.style.justifyContent='space-between';
      const exVol = lib.calcExerciseVolume(ex);
      exHeader.innerHTML = `<div>
          <div style="font-weight:900">${lib.esc(ex.name)} <span class="badge">${Math.round(exVol).toLocaleString('pl-PL')} kg</span></div>
          <div class="small muted">${ex.sets||''} s ‚Ä¢ ${ex.reps||''} ‚Ä¢ tempo ${ex.tempo||''} ‚Ä¢ przerwa ${ex.rest||''}</div>
        </div>
        <div class="row" style="flex-wrap:wrap">
          <button class="ghost" data-act="add-series" data-tr="${tr.id}" data-ex="${ex.id}">‚ûï Seria</button>
          <button class="ghost" data-act="edit-ex" data-tr="${tr.id}" data-ex="${ex.id}">Edytuj</button>
          <button class="ghost danger" data-act="del-ex" data-tr="${tr.id}" data-ex="${ex.id}">Usu≈Ñ</button>
        </div>`;
      exWrap.appendChild(exHeader);

      const series = ex.series || [];
      const table = document.createElement('table');
      table.className='table';
      table.style.marginTop='10px';
      table.innerHTML = `<thead><tr>
          <th>#</th><th>KG</th><th>Powt.</th><th>‚úÖ</th><th></th>
        </tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      if(series.length===0){
        const trr = document.createElement('tr');
        trr.innerHTML = `<td colspan="5" class="small muted">Brak serii ‚Äî kliknij ‚Äû‚ûï Seria‚Äù.</td>`;
        tbody.appendChild(trr);
      } else {
        series.forEach((s,i)=>{
          const trr = document.createElement('tr');
          trr.innerHTML = `<td>${i+1}</td>
            <td><input data-sfield="weight" data-sid="${s.id}" value="${s.weight ?? ''}" placeholder="kg" style="max-width:90px"></td>
            <td><input data-sfield="reps" data-sid="${s.id}" value="${s.reps ?? ''}" placeholder="powt." style="max-width:90px"></td>
            <td><input type="checkbox" data-sfield="done" data-sid="${s.id}" ${s.done ? 'checked' : ''}></td>
            <td><button class="ghost danger" data-act="del-series" data-tr="${tr.id}" data-ex="${ex.id}" data-sid="${s.id}">Usu≈Ñ</button></td>`;
          if(s.done) trr.classList.add('done');
          tbody.appendChild(trr);
        });
      }
      exWrap.appendChild(table);

      table.querySelectorAll('input[data-sfield]').forEach(inp=>{
        inp.addEventListener('change', async (e)=>{
          const sid = e.target.dataset.sid;
          const field = e.target.dataset.sfield;
          const sObj = (ex.series||[]).find(x=>x.id===sid);
          if(!sObj) return;
          if(field==='done'){
            sObj.done = !!e.target.checked;
          } else {
            const val = e.target.value.trim();
            sObj[field] = val==='' ? '' : Number(val);
          }
          setSaving(true);
          await lib.autosave(currentUser.uid, plan);
          setSaving(false);
          renderTrainingArea();
        });
      });

      body.appendChild(exWrap);
    });

    const addExRow = document.createElement('div');
    addExRow.className='row';
    addExRow.innerHTML = `<button class="button">‚ûï Dodaj ƒáwiczenie do ${lib.esc(tr.title)}</button>`;
    addExRow.querySelector('button').addEventListener('click', async ()=>{
      const name = prompt('Nazwa ƒáwiczenia', 'ƒÜwiczenie');
      if(!name) return;
      const ex = { id: lib.uid('ex'), name, sets:3, reps:'8-12', tempo:'2010', rest:"1:00", series:[] };
      tr.exercises = tr.exercises || [];
      tr.exercises.push(ex);
      setSaving(true);
      await lib.autosave(currentUser.uid, plan);
      setSaving(false);
      renderTrainingArea();
    });

    body.appendChild(addExRow);
    det.appendChild(body);
    trainingArea.appendChild(det);

    det.querySelectorAll('[data-act="edit-ex"]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const trId = e.currentTarget.dataset.tr;
        const exId = e.currentTarget.dataset.ex;
        const t = (week.data.trainings||[]).find(tt=>tt.id===trId);
        const ex = (t.exercises||[]).find(xx=>xx.id===exId);
        const newName = prompt('Nazwa ƒáwiczenia', ex.name);
        if(newName) ex.name = newName;
        const sets = prompt('Serie (liczba)', ex.sets);
        if(sets!==null && sets!=='') ex.sets = Number(sets);
        const reps = prompt('Powt√≥rzenia (np. 8-12)', ex.reps);
        if(reps!==null && reps!=='') ex.reps = reps;
        const tempo = prompt('Tempo (np. 2010)', ex.tempo||'');
        if(tempo!==null) ex.tempo = tempo;
        const rest = prompt('Przerwa (np. 1:00)', ex.rest||'');
        if(rest!==null) ex.rest = rest;

        setSaving(true);
        await lib.autosave(currentUser.uid, plan);
        setSaving(false);
        renderTrainingArea();
      });
    });

    det.querySelectorAll('[data-act="del-ex"]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const trId = e.currentTarget.dataset.tr;
        const exId = e.currentTarget.dataset.ex;
        const t = (week.data.trainings||[]).find(tt=>tt.id===trId);
        t.exercises = (t.exercises||[]).filter(x=>x.id!==exId);
        setSaving(true);
        await lib.autosave(currentUser.uid, plan);
        setSaving(false);
        renderTrainingArea();
      });
    });

    det.querySelectorAll('[data-act="add-series"]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const trId = e.currentTarget.dataset.tr;
        const exId = e.currentTarget.dataset.ex;
        const t = (week.data.trainings||[]).find(tt=>tt.id===trId);
        const ex = (t.exercises||[]).find(xx=>xx.id===exId);
        ex.series = ex.series || [];
        ex.series.push({ id: lib.uid('s'), weight:'', reps:'', done:false });
        setSaving(true);
        await lib.autosave(currentUser.uid, plan);
        setSaving(false);
        renderTrainingArea();
      });
    });

    det.querySelectorAll('[data-act="del-series"]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const trId = e.currentTarget.dataset.tr;
        const exId = e.currentTarget.dataset.ex;
        const sid = e.currentTarget.dataset.sid;
        const t = (week.data.trainings||[]).find(tt=>tt.id===trId);
        const ex = (t.exercises||[]).find(xx=>xx.id===exId);
        ex.series = (ex.series||[]).filter(s=>s.id!==sid);
        setSaving(true);
        await lib.autosave(currentUser.uid, plan);
        setSaving(false);
        renderTrainingArea();
      });
    });
  });
}

function renderAll(){
  renderPlans();
  renderHeader();
  renderTrainingArea();
}

btnAddPlan.addEventListener('click', async ()=>{
  const title = prompt('Nazwa planu','M√≥j plan');
  if(!title) return;
  const plan = { id: lib.uid('plan'), title, desc:'', trainings:[], weeks:[] };
  await lib.createPlan(currentUser.uid, plan);
  lib.showToast('‚úÖ Dodano plan');
});

btnAddTraining.addEventListener('click', async ()=>{
  const plan = state.plans.find(p=>p.id===state.activePlanId);
  if(!plan) return alert('Wybierz plan');
  const name = prompt('Nazwa treningu','Trening A');
  if(!name) return;
  plan.trainings = plan.trainings || [];
  const tr = { id: lib.uid('tr'), title: name, exercises:[] };
  plan.trainings.push(tr);
  (plan.weeks||[]).forEach(w=>{
    lib.ensureWeekData(plan, w);
    w.data.trainings.push(lib.clone(tr));
  });
  setSaving(true);
  await lib.autosave(currentUser.uid, plan);
  setSaving(false);
  renderAll();
});

btnAddWeek.addEventListener('click', async ()=>{
  const plan = state.plans.find(p=>p.id===state.activePlanId);
  if(!plan) return alert('Wybierz plan');
  const name = prompt('Nazwa tygodnia','Tydzie≈Ñ '+((plan.weeks||[]).length+1));
  if(!name) return;
  const wk = { id: lib.uid('wk'), title:name, data:{ trainings: lib.clone(plan.trainings || []) } };
  plan.weeks = plan.weeks || [];
  plan.weeks.push(wk);
  state.activeWeekId = wk.id;
  setSaving(true);
  await lib.autosave(currentUser.uid, plan);
  setSaving(false);
  renderAll();
});

btnDupWeek.addEventListener('click', async ()=>{
  const plan = state.plans.find(p=>p.id===state.activePlanId);
  if(!plan) return;
  const week = (plan.weeks||[]).find(w=>w.id===state.activeWeekId);
  if(!week) return;
  const copy = lib.clone(week);
  copy.id = lib.uid('wk');
  copy.title = week.title + ' (kopia)';
  plan.weeks.push(copy);
  state.activeWeekId = copy.id;
  setSaving(true);
  await lib.autosave(currentUser.uid, plan);
  setSaving(false);
  renderAll();
});

btnDelWeek.addEventListener('click', async ()=>{
  const plan = state.plans.find(p=>p.id===state.activePlanId);
  if(!plan) return;
  if(!state.activeWeekId) return;
  if(!confirm('UsunƒÖƒá tydzie≈Ñ?')) return;
  plan.weeks = (plan.weeks||[]).filter(w=>w.id!==state.activeWeekId);
  state.activeWeekId = (plan.weeks[0] ? plan.weeks[0].id : null);
  setSaving(true);
  await lib.autosave(currentUser.uid, plan);
  setSaving(false);
  renderAll();
});

weekSelect.addEventListener('change', e=>{
  state.activeWeekId = e.target.value;
  renderTrainingArea();
});

function recalc1rm(){
  const w = Number(rmW.value||0), r = Number(rmR.value||0);
  if(!w || !r) return rmOut.textContent='‚Äî';
  rmOut.textContent = Math.round(lib.oneRm.epley(w,r)) + ' kg';
}
rmW.addEventListener('input', recalc1rm);
rmR.addEventListener('input', recalc1rm);

lib.auth.onAuthStateChanged(async user=>{
  currentUser = user;
  if(!user){ window.location.href = 'login.html'; return; }
  userEmail.textContent = user.email;
  await lib.ensureUserDoc(user.uid, user.email);

  lib.subscribePlans(user.uid, plans=>{
    state.plans = plans;
    if(!state.activePlanId && plans.length) state.activePlanId = plans[0].id;
    const activePlan = state.plans.find(p=>p.id===state.activePlanId);
    if(activePlan && (!state.activeWeekId || !(activePlan.weeks||[]).some(w=>w.id===state.activeWeekId))){
      state.activeWeekId = (activePlan.weeks && activePlan.weeks[0]) ? activePlan.weeks[0].id : null;
    }
    renderAll();
  });
});
</script>
</body>
</html>
